{% extends "base.html" %}
{% load static %}
{% load main_filters %}

{% block title %}Dashboard{% endblock %}

{% block head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'main/dashboard.css' %}">
{% endblock %}

{% block content %}
  <!-- Greeting -->
  <div class="dashboard-header">
    <h2>Welcome back, teachers!</h2>
    <div class="brand-line">
      <span class="lead-in">Let‚Äôs</span>
      <span class="sort2support-brand">
        <span class="sort">Sort</span><span class="two">2</span><span class="support">Support</span>
      </span>
      <span class="lead-out">!</span>
    </div>
  </div>
  <div style="position: absolute; top: 20px; right: 20px;">
    <form method="post" action="{% url 'main:reset_class' %}" style="display:inline; margin-left: 20px;">
      {% csrf_token %}
      <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Reset everything and start over?')">
        üîÑ Start Over
      </button>
    </form>
  </div>

  <!-- Step 1: Choose Concept for the week  -->
  <div id="step1" class="step-block">
    <!-- Step 1 content -->

    <details open>
      <summary>
        <h3 id="lessonSelection">
          Step 1: Select Concepts from the Week's Lessons
          <span class="step-badge
            {% if current_step == 'step1' %}active{% endif %}
            {% if step1_done and current_step != 'step1' %}done{% endif %}">
            {% if step1_done %}‚úì{% else %}Step 1{% endif %}
          </span>
        </h3>
      </summary>

      <form method="post" action="">
        {% csrf_token %}
        <div class="concept-row">
          <label for="lesson_1">Concept 1:</label>
          <select name="lesson_1" id="lesson_1" required>
            {% for lesson in ufli_lessons %}
            <option value="{{ lesson.number }}"
              {% if lesson.number|stringformat:"s" == request.session.lesson_1_id %}selected{% endif %}>

              Lesson {{ lesson.number }}: {{ lesson.concept }} (Max: {{ lesson.total_points }})
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="concept-row">
          <label for="lesson_2" style="margin-left: 20px;">Concept 2:</label>
          <select name="lesson_2" id="lesson_2" required>
            {% for lesson in ufli_lessons %}
              <option value="{{ lesson.number }}"
                {% if lesson.number|stringformat:"s" == request.session.lesson_2_id %}selected{% endif %}>
                Lesson {{ lesson.number }}: {{ lesson.concept }} (Max: {{ lesson.total_points }})
              </option>
            {% endfor %}
          </select>
        </div>

        <button type="submit" name="save_lessons" class="btn btn-outline-primary mt-2">
          üíæ Save Lesson Selection
        </button>
      </form>

      {% if step1_success %}
        <div class="step-success mt-2">{{ step1_success }}</div>
        <script>
          setTimeout(() => {
            const step1Details = document.querySelector("#step1 details");
            if (step1Details) step1Details.open = false;

            setTimeout(() => {
              const step2 = document.getElementById("step2");
              if (step2) {
                step2.scrollIntoView({ behavior: "smooth", block: "start" });
                const details = step2.querySelector("details");
                if (details) details.open = true;
              }
            }, 600);
          }, 2000);
        </script>
      {% endif %}

      {% if step1_error %}
        <div class="step-error mt-2">{{ step1_error }}</div>
      {% endif %}
    </details>

  <!-- Step 2: Choose Entry Mode -->
  <details id="step2" open>
    <summary>
      <h3 id="step2Header">
        Step 2: Upload Student Scores
        <span class="step-badge
          {% if current_step == 'step2' %} active{% endif %}
          {% if step2_done and current_step != 'step2' %} done{% endif %}">
          {% if step2_done %}‚úì{% else %}Step 2{% endif %}
        </span>
      </h3>
    </summary>

    <p style="font-style: italic;">Paste names directly, upload from Excel, or load a previous roster.</p>

    <!-- Mode selector dropdown-->
    <form method="post">
      {% csrf_token %}
      <select name="entry_mode" onchange="this.form.submit()" class="form-select" style="width: 220px;">
        <option value="paste" {% if entry_mode == "paste" %}selected{% endif %}>Paste Names</option>
        <option value="upload" {% if entry_mode == "upload" %}selected{% endif %}>Upload from Excel</option>
        <option value="load" {% if entry_mode == "load" %}selected{% endif %}>Load Previous Roster</option>
      </select>
    </form>

    <!-- Paste Entry -->
    {% if entry_mode == "paste" %}

      <div id="manualBlock" style="margin-top: 20px;">
        <h4>Paste Student Names</h4>
        <form method="post" action="">
          {% csrf_token %}
          <textarea name="roster_raw" rows="6" cols="50" placeholder="Paste names here, one per line..."></textarea>
          <button type="submit" name="process_roster_raw" class="btn btn-outline-success mt-2">
          üìã Save to Preview Table
          </button>
        </form>
      </div>
    {% endif %}


    <!-- Upload block -->
    {% if entry_mode == "upload" %}
      <h4 class="mt-4">Upload Student Roster</h4>

      <form method="post" enctype="multipart/form-data" class="mt-3">
        {% csrf_token %}

        <a href="{% url 'main:download_template' %}" class="btn btn-outline-secondary mt-2">
          üìÑ Download Sample Template
        </a>

        {% if loaded_roster_name %}
          <p class="text-muted">Roster loaded: {{ loaded_roster_name }}</p>
        {% endif %}

        <small class="form-text text-muted mb-2">
          Accepted formats: .xlsx or .xls. Must include columns: name, score1, score2.
        </small>

        <input type="file" name="roster_file" accept=".xlsx,.xls" required class="form-control mb-2">

        <button type="submit" name="process_roster_upload" class="btn btn-outline-primary">
          üì§ Upload Roster and Create Preview Table
        </button>
      </form>
    {% endif %}


    <!-- Step 2c: Load or Manage Saved Rosters -->
    {% if entry_mode == "load" %}
      <div class="mt-3">
        <summary>
          <h3 id="step3Header">
          <p>You can restore a roster from this session or from your saved list.</p>
            Step 3: Preview & Edit Roster
            <span class="step-badge
              {% if current_step == 'step3' %} active{% endif %}
              {% if step3_done and current_step != 'step3' %} done{% endif %}">
              {% if step3_done %}‚úì{% else %}Step 3{% endif %}
            </span>
          </h3>
        </summary>



        <!-- Scoped messages for Step 2c -->
        {% if messages %}
          {% for message in messages %}
            {% if "step2c" in message.tags %}
              <div class="step-{{ message.level_tag }} mt-2">{{ message }}</div>
            {% endif %}
          {% endfor %}
        {% endif %}


        <form method="post" action="">
          {% csrf_token %}
          <button type="submit" name="load_previous_roster" class="btn btn-outline-primary">
            üîÅ Load Session Roster
          </button>
        </form>

        {% if saved_rosters %}
          <form method="post" class="mt-3">
            {% csrf_token %}
            <label for="roster_id">Select a saved roster:</label>
            <select name="roster_id" required>
              {% for roster in saved_rosters %}
                <option value="{{ roster.id }}">{{ roster.name }} ({{ roster.created_at|date:"M d, Y" }})</option>
              {% endfor %}
            </select>
            <div class="mt-2">
              <button type="submit" name="load_selected_roster" class="btn btn-outline-success">üóÇÔ∏è Load</button>
              <button type="submit" name="delete_roster" class="btn btn-outline-danger">üóëÔ∏è Delete</button>
            </div>
          </form>
        {% else %}
          <p class="text-muted mt-2">No saved rosters yet.</p>
        {% endif %}
      </div>
    {% endif %}
    {% if loaded_roster_name %}
      <p class="text-muted">Roster loaded: {{ loaded_roster_name }}</p>
    {% endif %}

  </details>

  <!-- Step 3: Preview & Edit -->
  {% if preview_data %}
    <details id="step3" {% if entry_mode == "load" or entry_mode == "upload" or entry_mode == "preview" %}open{% endif %}>
      <summary>
        <h3 id="step3Header">
          Step 3: Preview & Edit Roster
          <span class="step-badge
            {% if current_step == 'step3' %} active{% endif %}
            {% if step3_done and current_step != 'step3' %} done{% endif %}">
            {% if step3_done %}‚úì{% else %}Step 3{% endif %}
          </span>
        </h3>
      </summary>

      <div id="previewTableContainer">

        <!-- Upload Roster Form -->
        <form method="post" action="">
          {% csrf_token %}
          {% if lesson_1 and lesson_2 %}
            <h4 class="preview-heading">
              Previewing scores for 
              <span class="concept-label">{{ lesson_1.concept }}</span> (Max: {{ lesson_1.total_points }}) 
              and 
              <span class="concept-label">{{ lesson_2.concept }}</span> (Max: {{ lesson_2.total_points }})
            </h4>
          {% endif %}

          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Name</th>
                <th>Score 1 {% if lesson_1 %}(max {{ lesson_1.total_points }}){% endif %}</th>
                <th>Score 2 {% if lesson_2 %}(max {{ lesson_2.total_points }}){% endif %}</th>
              </tr>
            </thead>
            <tbody>
              {% for student in preview_data %}
                <tr>
                  <td>
                    <input type="text" name="name_{{ forloop.counter }}" value="{{ student.name }}" required>
                  </td>

                  <td{% if student.missing_score1 %} class="table-danger"{% endif %}>
                    <input type="number" name="score1_{{ forloop.counter }}"
                          value="{{ student.score1|default_if_none:'0' }}"
                          {% if student.missing_score1 %}class="missing-cell"{% endif %}>
                  </td>

                  <td{% if student.missing_score2 %} class="table-danger"{% endif %}>
                    <input type="number" name="score2_{{ forloop.counter }}"
                          value="{{ student.score2|default_if_none:'0' }}"
                          {% if student.missing_score2 %}class="missing-cell"{% endif %}>
                  </td>

                  <td>
                    <input type="checkbox" name="delete_{{ forloop.counter }}"> ‚ùå Remove
                  </td>
                </tr>

              {% endfor %}


              <!-- Blank row for adding a new student -->
              <tr>
                <td><input type="text" name="new_name" placeholder="New student name"></td>
                <td><input type="number" name="new_score1" placeholder="0"></td>
                <td><input type="number" name="new_score2" placeholder="0"></td>
                <td><em>‚ûï Add row</em></td>
              </tr>
            </tbody>
          </table>

          <input type="hidden" name="student_count" value="{{ preview_data|length }}">

          <div class="mt-3">
            <label for="roster_name">Roster name:</label>
            <input type="text" name="roster_name" placeholder="e.g. Fall Benchmark" required>
          </div>
          <p class="form-text text-muted">
            Review and edit your roster, then click <strong>Save Roster for Grouping</strong>
          </p>
          <div class="mt-2">
            <button type="submit" name="save_roster_raw" class="btn btn-success">
            üì§ Save Roster for Grouping
            </button>

            {% if roster_uploaded %}
              <div class="step-success mt-2">
              ‚úÖ Roster "{{ roster_name }}" saved successfully. You can now group students in Step 4.
              </div>
            {% endif %}

            {% if upload_error %}
              <div class="step-error mt-2">
                {{ upload_error }}
              </div>
            {% endif %}
          </div>
        </form>

        <!-- Reset Class Form (separate) -->
        <form method="post" action="{% url 'main:reset_class' %}" style="margin-top: 10px;">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Reset everything and start over?')">
            üîÑ Reset & Start Over
          </button>
        </form>

        <!-- Legend and Reminder -->
        <div class="preview-legend mt-3">
          <span class="legend-swatch missing-cell-swatch"></span>
          <span class="legend-text">Red = missing score, saved as 0</span>
        </div>
        <p class="form-text text-muted mt-1">
          ‚ö†Ô∏è Remember: this is only a preview. Students will disappear after logout unless you save the roster.
        </p>
      </div>
    </details>
  {% endif %}



  <!-- Step 4: Sort2Support -->
  {% if preview_data and lesson_1_id and lesson_2_id %}
    <details id="step4" {% if step4_open %}open{% endif %}>
      <summary>
        <h3 id="step4Header">
          Step 4: Group Students with Sort2Support
          &nbsp;
          <span class="step-badge{% if current_step == 'step4' %} active{% endif %}{% if step4_done and current_step != 'step4' %} done{% endif %}">
            {% if step4_done %}‚úì{% else %}Step 4{% endif %}
          </span>
        </h3>
      </summary>

      <!-- Table of inputs will be injected here -->
      <div id="tableContainer" style="margin-top: 20px; display: none;"></div>


      <!-- Debug info -->
      <p>Debug: preview_data={{ preview_data|length }}, lesson_1_id={{ lesson_1_id }}, lesson_2_id={{ lesson_2_id }}</p>
      
      <!-- Sort2Support form -->
      <form method="post" action="">
        {% csrf_token %}
        <input type="hidden" name="lesson_1" value="{{ lesson_1_id }}">
        <input type="hidden" name="lesson_2" value="{{ lesson_2_id }}">
        <input type="hidden" name="sort2support" value="true">

        <button type="submit" name="sort2support" class="sort2support-btn">
          <img src="{% static 'img/sort2support_logo.png' %}" 
              alt="Sort2Support" 
              class="sort2support-logo">
          <span class="sr-only">Run Sort2Support Grouping</span>
        </button>
      </form>

      <!-- Scoped messages for Step 4 -->
      {% for message in messages %}
        {% if "step4" in message.tags %}
          <div class="step-{{ message.level_tag }} mt-2">{{ message }}</div>
        {% endif %}
      {% endfor %}

      <!-- Reset button -->
      <form method="post" action="{% url 'main:reset_class' %}" style="margin-top: 10px;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">
          üóëÔ∏è Clear All Students/Scores
        </button>
      </form>
    </details>
  {% endif %}

  <p>Debug: lesson_1_id={{ lesson_1_id }}, lesson_2_id={{ lesson_2_id }}, preview_data={{ preview_data|length }}</p>


  <!-- Step 5: Group Students -->
  {% if group_success %}
    <div class="step-success mt-2">{{ group_success }}</div>
  {% endif %}

  {% if grouped_html %}
    <details id="step5" open>
      <summary><h3>Step 5: Daily Grouping Summary</h3></summary>
      <div id="groupingSection" style="display: flex; gap: 30px; align-items: flex-start; margin-top: 20px;">

        <!-- Main Results -->
        <div id="groupResults" style="flex: 2;">
          <div class="collapsible-section">
            <button type="button" class="collapsible-toggle" onclick="toggleGroupingInfo()">
              ‚ñ∂ Grouping Info
            </button>

            <div id="groupingInfoContent" class="collapsible-content">
              <div class="grouping-info">
                <p><strong>Based on:</strong></p>
                {% if lesson_1 %}
                  <div class="concept-line">
                    <strong>{{ lesson_1.concept }} (Max {{ lesson_1.total_points }})</strong>
                  </div>
                {% endif %}
                {% if lesson_2 %}
                  <div class="concept-line">
                    <strong>{{ lesson_2.concept }} (Max {{ lesson_2.total_points }})</strong>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          {% if grouped_data.daily %}
            <div class="grouped-preview mt-3 p-3 border rounded bg-light">
              <h5 class="mb-2">üìä Daily Grouping Table</h5>
              <table class="daily-grouping-table table table-bordered">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Group 1 {% if lesson_1 %}({{ lesson_1.concept }}){% endif %}</th>
                    <th>Score 1</th>
                    <th>Group 2 {% if lesson_2 %}({{ lesson_2.concept }}){% endif %}</th>
                    <th>Score 2</th>
                  </tr>
                </thead>
                <tbody>
                  {% for student in grouped_data.daily %}
                    <tr>
                      <td>{{ student.name }}</td>
                      <td class="{{ student.group_1|lower }}">{{ student.group_1 }}</td>
                      <td>{{ student.score1 }}</td>
                      <td class="{{ student.group_2|lower }}">{{ student.group_2 }}</td>
                      <td>{{ student.score2 }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>  
          {% endif %}
          <!-- ‚úÖ Add this to show concept1 and concept2 tables -->
          {% include "main/_grouped_tables.html" %}

          <!-- Export & Reset Buttons -->
          <div class="action-buttons" style="margin-top: 20px;">
            <a href="{% url 'main:generate_excel_view' %}" class="btn btn-primary mt-2">üìÖ Export Weekly Plan</a>
<!--             <a href="{% url 'main:download_template' %}" class="btn btn-secondary mt-2">üìÑ Download Blank Template</a>-->
            <form method="post" action="{% url 'main:reset_class' %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger mt-2">üîÑ Reset Class</button>
            </form>
          </div>
        </div> <!-- /#groupResults -->

        <!-- Sidebar Key -->
        <aside class="side-keys" style="flex: 1; border-left: 2px solid #ccc; padding-left: 20px;">
          <h3>How Students Are Grouped</h3>
          <p>
            Each student's score is converted to a percentage based on the total possible points
            for the concept. This percentage determines their color group:
          </p>
          <table class="reference-table">
            <thead>
              <tr>
                <th>Score Range</th>
                <th>Color Group</th>
                <th>Interpretation</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>0‚Äì25%</td><td class="red">Red</td><td>Needs intensive support</td></tr>
              <tr><td>26‚Äì60%</td><td class="yellow">Yellow</td><td>Emerging understanding</td></tr>
              <tr><td>61‚Äì99%</td><td class="green">Green</td><td>Approaching mastery</td></tr>
              <tr><td>100%</td><td class="blue">Blue</td><td>Ready to move on</td></tr>
            </tbody>
          </table>
        </aside>

      </div> <!-- /#groupingSection -->
    </details>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
  // Toggle between manual paste and upload blocks
  function toggleEntryMode() {
    const mode = document.getElementById("entryMode").value;

    document.getElementById("manualBlock").style.display = (mode === "paste" || mode === "preview") ? "block" : "none";
    document.getElementById("pasteButtons").style.display = (mode === "paste") ? "block" : "none";
    document.getElementById("templateDownload").style.display = (mode === "upload") ? "block" : "none";
    document.getElementById("uploadBlock").style.display = (mode === "upload") ? "block" : "none";
    document.getElementById("loadBlock").style.display = (mode === "load") ? "block" : "none";
    document.getElementById("previewButtons").style.display = (mode === "preview") ? "block" : "none";

    const tableContainer = document.getElementById("tableContainer");
    if (mode === "paste") {
      tableContainer.style.display = "block";
    } else {
      tableContainer.innerHTML = "";
      tableContainer.style.display = "none";
    }
  }
    document.addEventListener("DOMContentLoaded", function () {
      const step3 = document.querySelector("#step3");
      if (step3 && step3.hasAttribute("open")) {
        step3.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });

    window.addEventListener("load", () => {
      const mode = "{{ entry_mode|default:'paste' }}";
      const entrySelect = document.querySelector('select[name="entry_mode"]');
      if (entrySelect) {
        entrySelect.value = mode;
        toggleEntryMode();
      }

      {% if request.session.lesson_1_id and request.session.lesson_2_id and not preview_data and not grouped_html %}
        const header = document.getElementById("lessonSelection");
        header?.scrollIntoView({ behavior: "smooth" });
        header?.classList.add("highlight");
        setTimeout(() => header?.classList.remove("highlight"), 1500);
      {% endif %}
    });

    // Helper: split pasted names into an array
    function getNames() {
      const text = document.getElementById("pasteArea").value.trim();
      return text.split("\n").map(n => n.trim()).filter(n => n.length > 0);
    }

  // Helper: build a table of inputs from pasted names
  function buildTable(names) {
    const container = document.getElementById("tableContainer");
    container.innerHTML = "";
    if (names.length === 0) return;

    let html = "<table class='table table-bordered'><thead><tr><th>Name</th><th>Score 1</th><th>Score 2</th></tr></thead><tbody>";
    names.forEach((name, i) => {
      html += `<tr>
        <td><input type="text" name="name_${i+1}" value="${name}" required></td>
        <td><input type="number" name="score1_${i+1}" value=""></td>
        <td><input type="number" name="score2_${i+1}" value=""></td>
      </tr>`;
    });
    html += "</tbody></table>";
    html += `<input type="hidden" name="student_count" value="${names.length}">`;
    container.innerHTML = html;
  }

  // Scroll helpers: auto-scroll to preview or results on load
  window.addEventListener("load", () => {
    {% if preview_data and not grouped_html %}
      document.getElementById("previewTableContainer")?.scrollIntoView({ behavior: "smooth" });
    {% endif %}
    {% if grouped_html %}
      document.getElementById("groupResults")?.scrollIntoView({ behavior: "smooth" });
    {% endif %}
  });
</script>
{% endblock %}