{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container preview-section">
  {% if is_edit_mode %}
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Edit Class Roster</h2>
      <a href="{% url 'excel_app:add_student' %}" class="btn btn-outline-primary">â• Add Student</a>
    </div>
  {% else %}
    <h2>ğŸ“‹ Preview Uploaded Students</h2>
    <div class="d-flex gap-3 mb-3">
      <a href="{% url 'excel_app:preview_uploaded_students' %}?edit=true" class="btn btn-outline-warning">âœï¸ Go Back to Edit</a>
      <form method="post" action="{% url 'excel_app:save_student_scores' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-success">âœ… Confirm & Save Students</button>
      </form>
    </div>
  {% endif %}

  {% if table %}
    <form method="post" action="{% url 'excel_app:save_student_scores' %}{% if is_edit_mode %}?edit=true{% endif %}">
      {% csrf_token %}

      {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-success{% endif %}">
          {{ message }}
        </div>
      {% endfor %}

      <table class="table table-striped table-bordered">
        <caption class="visually-hidden">Preview table of student scores</caption>
        <thead>
          <tr>
            <th>Name</th>
            {% for concept in concepts %}
              <th>{{ concept }}</th>
            {% endfor %}
            {% if is_edit_mode %}
              <th>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in table %}
            <tr>
              <td>{{ row.name }}</td>

              {% for key in score_keys %}
                {% with score=row[key] %}
                  <td class="{% if score == '' or score is None %}table-warning{% endif %}" title="{% if score == '' or score is None %}Missing score{% endif %}">
                    {% if is_edit_mode %}
                      <input type="text" name="{{ key }}_{{ forloop.counter }}" value="{{ score }}" class="form-control">
                    {% else %}
                      {{ score }}
                    {% endif %}
                  </td>
                {% endwith %}
              {% endfor %}

              {% if is_edit_mode %}
                <td>
                  <button type="submit" formaction="{% url 'excel_app:delete_student' row.id %}" formmethod="post" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete {{ row.name }}?');">
                    Delete
                  </button>
                </td>
              {% endif %}

              <input type="hidden" name="name_{{ forloop.counter }}" value="{{ row.name }}">
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <input type="hidden" name="total_rows" value="{{ table|length }}">

      {% if is_edit_mode %}
        <p>
          <span class="badge bg-warning text-dark">Yellow cells</span> indicate missing scores.
          You can fix them before saving or mark the student as <strong>Absent</strong> or <strong>Excused</strong>.
        </p>

        <button type="submit" class="btn btn-success">ğŸ’¾ Save Changes</button>
      {% endif %}
    </form>
  {% else %}
    <p>No student data found.</p>
  {% endif %}

  <hr class="my-4">

  <div class="d-flex flex-column flex-md-row align-items-start gap-3">
    <a href="{% url 'excel_app:parse_excel_upload' %}" class="btn btn-outline-secondary">â† Upload another file</a>
    <a href="{% url 'excel_app:reset_session' %}" class="btn btn-outline-danger">ğŸ—‘ï¸ Start Over</a>
  </div>

  <form method="post" enctype="multipart/form-data" action="{% url 'excel_app:parse_excel_upload' %}" class="mt-4">
    {% csrf_token %}
    <label for="file" class="form-label">ğŸ“ Re-upload Excel file:</label>
    <input type="file" name="file" id="file" accept=".xlsx,.xls" required class="form-control mb-2">
    <button type="submit" class="btn btn-primary">Upload</button>
  </form>
</div>
{% endblock %}